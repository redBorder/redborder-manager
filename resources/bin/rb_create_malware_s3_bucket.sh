#!/bin/bash

# Get cdomain
[ -f /etc/redborder/cdomain ] && cdomain=$(head -n 1 /etc/redborder/cdomain | tr '\n' ' ' | awk '{print $1}')

# Function to generate a random key
generate_random_key() {
  local key_length=$1
  local generated_key=$(tr -dc 'A-Za-z0-9' < /dev/urandom | head -c "$key_length")
  echo "$generated_key"
}

ACCESS_KEY=$(generate_random_key 20)
SECRET_KEY=$(generate_random_key 40)

# Add malware keys to s3_init_conf.yml
if [ -f /etc/redborder/s3_init_conf.yml ]; then
  grep -qE '^\s*malware:' /etc/redborder/s3_init_conf.yml
  if [ $? -ne 0 ] ; then
    echo "INFO: Adding malware keys to /etc/redborder/s3_init_conf.yml"
    cat >> /etc/redborder/s3_init_conf.yml <<-_RBEOF_

malware:
  access_key: $ACCESS_KEY
  secret_key: $SECRET_KEY
  bucket: malware
  endpoint: malware.s3.service.${cdomain}
_RBEOF_
  else
    echo "INFO: Malware keys already present in /etc/redborder/s3_init_conf.yml"
  fi
else
  echo "ERROR: /etc/redborder/s3_init_conf.yml not found, exiting..."
  exit 1
fi
